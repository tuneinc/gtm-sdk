___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Tune SDK",
  "categories": ["AFFILIATE_MARKETING", "ATTRIBUTION", "ADVERTISING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Provides an easy interface to use TUNE\u0027s client-side SDK tracking solution for tracking clicks and conversions, all from inside Google Tag Manager.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "PARAM_TABLE",
    "name": "init_fields",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "network_id",
          "displayName": "Network ID",
          "simpleValueType": true,
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "tracking_domain",
          "displayName": "Domain",
          "simpleValueType": true,
          "valueValidators": [
            {
              "type": "REGEX",
              "args": [
                "^http[s]?://.+"
              ],
              "errorMessage": "Tracking domain must begin with a protocol specifier, such as https://"
            }
          ],
          "help": "The network\u0027s tracking domain, with protocol (e.g. https://) at the beginning."
        },
        "isUnique": true
      }
    ],
    "displayName": "Network Setup",
    "help": "Enter one or more network ID values, with a valid tracking domain for each network.",
    "valueValidators": [
      {
        "type": "TABLE_ROW_COUNT",
        "args": [
          1,
          20
        ],
        "errorMessage": "Information for at least one network must be provided to use this tag."
      }
    ],
    "newRowButtonText": "Add a Network",
    "alwaysInSummary": false
  },
  {
    "type": "RADIO",
    "name": "action",
    "displayName": "Action",
    "radioItems": [
      {
        "value": "identify",
        "displayValue": "Identify"
      },
      {
        "value": "convert",
        "displayValue": "Convert"
      }
    ],
    "simpleValueType": true,
    "help": "The tag on each page must either make an identify call (like a click), or a conversion call."
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "click_default_fields",
    "displayName": "Default Click Parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Name",
        "name": "click_default_name",
        "type": "TEXT",
        "selectItems": [
          {
            "value": "aff_sub",
            "displayValue": "aff_sub"
          },
          {
            "value": "aff_sub2",
            "displayValue": "aff_sub2"
          },
          {
            "value": "aff_sub3",
            "displayValue": "aff_sub3"
          },
          {
            "value": "aff_sub4",
            "displayValue": "aff_sub4"
          },
          {
            "value": "aff_sub5",
            "displayValue": "aff_sub5"
          },
          {
            "value": "source",
            "displayValue": "source"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "click_default_value",
        "type": "TEXT"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add Default Click Parameter",
    "help": "A default click parameter can be any of the parameters listed in our \"Customizing a Partner Tracking Link\" help article: https://help.tune.com/hasoffers/customizing-an-affiliate-tracking-link/#table-of-parameters\n\nIf a default parameter is set here and that same parameter is also included in the URL that lands on this page, then the value from the URL will be preferred and the value set here will be ignored."
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "click_override_fields",
    "displayName": "Click Parameter Overrides",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Name",
        "name": "click_override_name",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "click_override_value",
        "type": "TEXT"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add Click Parameter Override",
    "help": "A click parameter override can be any of the parameters listed in our \"Customizing a Partner Tracking Link\" help article: https://help.tune.com/hasoffers/customizing-an-affiliate-tracking-link/#table-of-parameters\n\nIf an override parameter is set here and the same parameter is included in the URL that lands on this page, the URL parameter will be ignored and the value set here will take precedence."
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "conversion_fields",
    "displayName": "Conversion Parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Name",
        "name": "conversion_name",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "conversion_value",
        "type": "TEXT"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "convert",
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add Conversion Parameter",
    "help": "A conversion parameter can be any of the parameters listed on our \"Customizing a Conversion Link\" help article: https://help.tune.com/hasoffers/customizing-a-conversion-link/#table-of-parameters"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require("logToConsole");
const inject = require("injectScript");
const setWindow = require("setInWindow");
const getWindow = require("copyFromWindow");

let onSuccess = function () {
    log("TUNE SDK: loaded SDK library");
};
let onFailure = function () {
    log("TUNE SDK: ERROR: failed to load SDK library");
    data.gtmOnFailure();
};

// A version of the "snippet" that is typically provided in the TUNE
// documentation, modified to work with Google's limited JS sandbox.
(function () {
    let tdl = getWindow("tdl") || [];
    if (!tdl.invoked) {
        tdl.invoked = true;
        tdl.methods = ["identify", "convert"];

        tdl.factory = function (method) {
            return function () {
                let newTdl = getWindow("tdl");
                let argArray = [];
                for (let i = 0; i < arguments.length; i++) {
                    argArray[i] = arguments[i];
                }
                argArray.unshift(method);
                newTdl.push(argArray);
                setWindow("tdl", newTdl, true);
                return newTdl;
            };
        };

        for (let i = 0; i < tdl.methods.length; i++) {
            var key = tdl.methods[i];
            tdl[key] = tdl.factory(key);
        }
        tdl.init = function (idAndDomain) {
            let newTdl = getWindow("tdl");
            newTdl.domain = idAndDomain;
            setWindow("tdl", newTdl, true);
            return newTdl;
        };

        setWindow("tdl", tdl, true);
        inject("https://js.go2sdk.com/v2/tune.js", onSuccess, onFailure);
    }
})();

// Get a copy of the tdl object and use it to initialize the SDK with one or
// more network IDs and tracking domains.
let tdl = getWindow("tdl");
let initObject = {};
data.init_fields.forEach((el) => {
    initObject[el.network_id] = el.tracking_domain;
});
tdl = tdl.init(initObject);

// Depending on the action chosen by the user of this template, grab any
// parameters provided in the tag definition and perform the requested action.
if (data.action === "identify") {
    // Parameters have to be converted from the format provided by the tag manager
    // to the format expected by the TUNE SDK methods.
    let defaults = data.click_default_fields === undefined ?
        {} : 
        data.click_default_fields.reduce((acc, curr) => { 
            acc[curr.click_default_name] = curr.click_default_value;
            return acc;
        }, {});
    let overrides = data.click_override_fields === undefined ? 
        {} : 
        data.click_override_fields.reduce((acc, curr) => {
            acc[curr.click_override_name] = curr.click_override_value;
            return acc;
        }, {});

    tdl.identify(defaults, overrides);
} else if (data.action === "convert") {
    let params = data.conversion_fields === undefined ? 
        {} :
        data.conversion_fields.reduce((acc, curr) => {
            acc[curr.conversion_name] = curr.conversion_value;
            return acc;
        }, {});

    tdl.convert(params);
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://js.go2sdk.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "tdl"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 9/10/2020, 8:28:10 PM


